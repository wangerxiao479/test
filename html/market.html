<!DOCTYPE html>
<html>

<head>
    <meta content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0" name="viewport" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <title>查看行情</title>
    <link href="../css/common.css" type="text/css" rel="stylesheet" />
    <link href="../fontico/iconfont.css" rel="stylesheet" type="text/css" />
    <link href="../css/index.css" type="text/css" rel="stylesheet" />
    <link href="../css/strategy.css" type="text/css" rel="stylesheet" />
    <link href="../css/swiper.min.css" type="text/css" rel="stylesheet" />
    <link href="../css/layer.css" type="text/css" rel="stylesheet" />
    <link href="../css/my.css" type="text/css" rel="stylesheet" />
    <link href="../css/style.css" type="text/css" rel="stylesheet" />
    <link href="../css/quotation.css" type="text/css" rel="stylesheet" />
    <link href="../css/wan-spinner.css" type="text/css" rel="stylesheet" />

    <!--核心模块-->
    <script type="text/javascript" src="../script/api.js"></script>
    <script type="text/javascript" src="../script/app.js"></script>
    <script type="text/javascript" src="../js/jquery.min.js"></script>
    <script type="text/javascript" src="../js/fastclick.js"></script>
    <!--通用组件-->
    <script type="text/javascript" src="../js/main.js"></script>
    <script type="text/javascript" src="../js/swiper.min.js"></script>
    <script type="text/javascript" src="../script/layer.js"></script>
    <script type="text/javascript" src="../script/highstock.js"></script>
    <script type="text/javascript" src="../script/broken-axis.js"></script>
    <script type="text/javascript" src="../script/wan-spinner.js"></script>
    <!--通信组件-->
    <script type="text/javascript" src="../script/core-min.js"></script>
    <script type="text/javascript" src="../script/aes.js"></script>
    <script type="text/javascript" src="../script/secret.js"></script>
    <script type="text/javascript" src="../script/cacheAjax.js"></script>
    <script type="text/javascript" src="../script/artTemplate.js"></script>
    <script type="text/javascript" src="../script/enum.js"></script>
    <script type="text/javascript" src="../script/chartExt.js"></script>

</head>
<style type="text/css">
    .pro-symbol.active {
        background-color: #fff;
    }

    .stalls table tr td {
        font-size: 14px;
        line-height: 24px;
        word-break: keep-all;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .stalls table tr.green td {
        color: green;
    }

    .stalls table tr.red td {
        color: red;
    }

    .layui-m-layercont {
        padding: 20px !important;
        text-align: left;
    }
</style>

<script type="text/javascript">
    var sysConfig;
    var isInitChart = false;
    var isInitKChart = false;

    $(function() {
        var tabsSwiper = new Swiper('.swiper-container', {
            speed: 500,
            allowSwipeToNext: false,
            allowSwipeToPrev: false,
            onSlideChangeStart: function() {
                $("#wrapper-tabs li.active").removeClass('active')
                $("#wrapper-tabs li").eq(tabsSwiper.activeIndex).addClass('active')
            },
            onSlideChangeEnd: function() {
                if (tabsSwiper.activeIndex == 1) {

                }
            }
        })
        $(".gp-onoff").click(function() {
            $(".gp-market").toggle();
            $(this).toggleClass("icon-rotate-copy");
        });
        /* 推荐选择*/
        $(".trade-money li").click(function() {
            $(this).addClass("on").siblings().removeClass("on");
            var value = $(this).html();
            $api.dom("#i-xyj").value = value;
        });
        $("#wrapper-tabs li").click(function() {
            $("#wrapper-tabs li.active").removeClass('active');
            $(this).addClass('active');
            tabsSwiper.unlockSwipeToNext();
            tabsSwiper.unlockSwipeToPrev();
            tabsSwiper.slideTo($(this).index());
            tabsSwiper.lockSwipeToNext();
            tabsSwiper.lockSwipeToPrev();
        });

        $(".gp-tabs li").on('touchstart mousedown', function(e) {
            e.preventDefault()
            $(".gp-tabs .active").removeClass('active')
            $(this).addClass('active')

            var tradeMode = $("#tradeMode .active").attr("value");
            if (tradeMode == "t1") {
                $("#T1Data").show();
                $("#TNData").hide();
            } else {
                $("#T1Data").hide();
                $("#TNData").show();
            }
        })
        $(".gp-tabs li").click(function(e) {
            e.preventDefault()
        });
    });

    var stockCode = "";
    _apiready = function() {
        stockCode = api.pageParam.stockCode;
        template.helper("fixd", function(dec) {
            if (dec != null) {
                if (typeof(dec) == "string"); {
                    dec = parseFloat(dec);
                }
                return dec.toFixed(2);
            } else
                return "0.00";
        });

        template.helper("DateFormat", function(jsondate) {
            if (jsondate != null) {
                return jsondate.replace('T', ' ').substring(5, 16);
            } else {
                return "";
            }
        });
        QueryConfig(function() {
            showLoading();
            QueryStockInfo();
            var userInfo = getUserInfo();
            if (isInitKChart == false) {
                initKChart();
                isInitKChart = true;
            }
        });

        queryStrategy();

        if (api.pageParam.Type == 0) {
            $("#addlink").click(function() {
                api.openWin({
                    name: 'addStrategy',
                    url: 'addStrategy.html',
                    pageParam: {
                        stockCode: stockCode
                    }
                });
            });

        } else {
            $("#addlink").click(function() {
                api.openWin({
                    name: 'simulationTrade',
                    url: 'simulationTrade.html',
                    pageParam: {
                        stockCode: stockCode
                    }
                });
            });
        }
    };

    function QueryConfig(end) {
        sendGet(ServicesConifg.SysConfig.QuerySysConfig,
            function(succ) {
                sysConfig = succ[0];
                end();
            },
            function(err) {
                showToast("加载服务器配置失败");
                api.closeWin();
            }
        );
    };

    function QueryStockInfo() {
        var param = {
            "stockcode": stockCode
        };
        sendPost(ServicesConifg.Quotation.QueryMarket, param,
            function(data) {
                data.UpLimit = data.PreClose * 1.1;
                data.DownLimit = data.PreClose * 0.9;
                data.Differential = data.CurrentMatch - data.PreClose;
                data.DifferentialPersent = ((data.Differential / data.PreClose) * 100).toFixed(2);
                if (data.Differential > 0) {
                    $("#_newPrice").addClass("red").removeClass("green");
                    $("#_newDiff").addClass("red").removeClass("green");
                } else if (data.Differential < 0) {
                    $("#_newPrice").addClass("green").removeClass("red");
                    $("#_newDiff").addClass("green").removeClass("red");
                } else {
                    $("#_newPrice").removeClass("green").removeClass("red");
                    $("#_newDiff").removeClass("green").removeClass("red");
                }
                $("#_newPrice").html(data.CurrentMatch);
                $("#_newDiff").html(data.DifferentialPersent + "%");
                if (data.Differential > 0) {
                    data.Color = "red";
                } else if (data.Differential < 0) {
                    data.Color = "green";
                } else {
                    data.Color = "black";
                }

                priceData = data;
                $api.dom("#stockInfo").innerHTML = template("templateStock", data);
                var Handicap = new Array();
                for (var i in data.SellHandicap) {
                    var cls = "black";
                    if (data.SellHandicap[i].Price > data.PreClose) {
                        cls = "red";
                    } else if (data.SellHandicap[i].Price < data.PreClose) {
                        cls = "green";
                    }
                    Handicap.unshift({
                        Index: "卖" + data.SellHandicap[i].Index,
                        Price: data.SellHandicap[i].Price.toFixed(2),
                        Volume: convertWan(data.SellHandicap[i].Volume),
                        cls: cls
                    });
                }

                for (var i in data.BuyHandicap) {
                    var cls = "black";
                    if (data.BuyHandicap[i].Price > data.PreClose) {
                        cls = "red";
                    } else if (data.BuyHandicap[i].Price < data.PreClose) {
                        cls = "green";
                    }
                    Handicap.push({
                        Index: "买" + data.BuyHandicap[i].Index,
                        Price: data.BuyHandicap[i].Price.toFixed(2),
                        Volume: convertWan(data.BuyHandicap[i].Volume),
                        cls: cls
                    });
                }

                $api.dom("#stalls").innerHTML = template("templateStalls", {
                    List: Handicap
                });

                closeLoading();
                if (isInitChart == false) {
                    initChart();
                    isInitChart = true;
                }
            },
            function(err) {
                showToast("行情服务器异常");
                closeLoading();
            }, false, true
        );
        setTimeout(QueryStockInfo, 10000); //自动更新行情
    };

    function convertWan(volume) {
        if (volume > 10000) {
            return (volume / 10000).toFixed(2) + "万";
        } else {
            return volume;
        }
    };

    var yMaxPer, yMinPer;

    function initChart() {
        Highcharts.setOptions({
            useUTC: true
        });
        loadMinute(function(sucData, yMax, yMin, plotValue) {
            Highcharts.setOptions({
                global: {
                    useUTC: false
                }
            });
            $("#hqInfo").highcharts("StockChart", {
                chart: {
                    events: {
                        load: function() {
                            var series = this.series[0];
                            var yAxis = this.yAxis[0];
                            setInterval(function() {
                                loadMinute(function(_sucData, _yMax, _yMin, _plotValue) {
                                    series.setData(_sucData);
                                    yAxis.setExtremes(_yMin, _yMax * 1.005);
                                });
                            }, 6000);
                        }
                    }
                },
                credits: {
                    enabled: false
                },
                exporting: {
                    enabled: false
                },
                series: [{
                    name: '价格',
                    data: sucData,
                    lineWidth: 1,
                    color: "#89BAE3"
                }],
                xAxis: {
                    ordinal: false,
                    breaks: [{
                        from: translateTime("000000001130"),
                        to: translateTime("000000001300")
                    }],
                    min: translateTime("000000000930"),
                    max: translateTime("000000001500"),
                    plotLines: [{
                        value: translateTime("000000001300"),
                        color: '#D8D8D8',
                        width: 1,
                        dashStyle: "ShortDash"
                    }],
                },
                tooltip: {
                    useHTML: true,
                    headerFormat: "",
                    valueDecimals: 2
                },
                yAxis: {
                    ordinal: false,
                    max: yMax * 1.005,
                    min: yMin,
                    startOnTick: false,
                    endOnTick: false,
                    gridLineColor: null,
                    plotLines: [{
                        value: plotValue,
                        color: '#D8D8D8',
                        dashStyle: "ShortDash",
                        width: 1,
                        label: {
                            text: plotValue
                        }
                    }, {
                        value: yMax,
                        label: {
                            text: (yMax).toFixed(2),
                            verticalAlign: "middle"
                        }
                    }, {
                        value: yMin,
                        label: {
                            text: (yMin).toFixed(2),
                            verticalAlign: "top"
                        }
                    }],
                    labels: {
                        enabled: false
                    }
                },
                rangeSelector: false,
                scrollbar: false,
                navigator: false
            });
        });
    }

    function loadMinute(end) {
        var startTime = new Date().Format("yyyyMMdd092900");
        var hk = (stockCode.indexOf("6") == 0 ? "sse" : "szse") + stockCode;
        var url = "http://webstock.quote.hermes.hexun.com/a/minute?code=" + hk + "&start=" + startTime + "&number=1000";
        api.ajax({
            url: url,
            method: 'get',
            dataType: "text"
        }, function(ret, err) {
            if (ret) {
                var json = $api.strToJson(ret.substring(1, ret.length - 2));
                var _data = json.Data[0];
                var data = [];
                for (var i in _data) {
                    data.push([
                        translateTime(_data[i][0]),
                        _data[i][1] / 100
                    ]);
                }
                var yMax = json.Data[2] / 100;
                var yMin = json.Data[3] / 100;
                var plotValue = json.Data[1] / 100;
                var XP = Math.abs(yMax - plotValue);
                var NP = Math.abs(yMin - plotValue);
                var chazhi = XP;
                if (NP > XP) {
                    chazhi = NP;
                }
                yMax = plotValue + chazhi;
                yMin = plotValue - chazhi;
                end(data, yMax, yMin, plotValue);
            } else {}
        });
    }

    function translateTime(tb) {
        var hr = tb.toString().substring(8, 10); //小时
        var mi = tb.toString().substring(10, 12); //分钟
        var date = new Date();
        date.setHours(parseInt(hr));
        date.setMinutes(parseInt(mi));
        date.setSeconds(0);
        date.setMilliseconds(0);
        return date.getTime();
    }

    function translateDate(tb) {
        var year = tb.toString().substring(0, 4);
        var month = tb.toString().substring(4, 6);
        var day = tb.toString().substring(6, 8);
        var date = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
        return date.getTime();
    }

    function loadDayK(end) {
        var startTime = new Date().Format("yyyyMMdd092900");
        var hk = (stockCode.indexOf("6") == 0 ? "sse" : "szse") + stockCode;
        var url = "http://webstock.quote.hermes.hexun.com/a/kline?code=" + hk + "&start=" + startTime + "&number=-100&type=5";
        api.ajax({
            url: url,
            method: 'get',
            dataType: "text"
        }, function(ret, err) {
            if (ret) {
                var json = $api.strToJson(ret.substring(1, ret.length - 2));
                var _data = json.Data[0];
                var data = [];
                for (var i in _data) {
                    data.push([
                        translateDate(_data[i][0]),
                        _data[i][1] / 100, //前收盘价
                        _data[i][2] / 100, //开盘价
                        _data[i][3] / 100, //收盘价
                        _data[i][4] / 100, //最高价
                        _data[i][5] / 100, //最低价
                        _data[i][6], //成交量
                        _data[i][7] //成交额
                    ]);
                }
                end(data);
            } else {}
        });
    };

    function initKChart() {
        loadDayK(function(data) {
            var vlInfo = "";
            $.each(data, function(i, value) {
                var zde = value[3] - value[1]; //涨跌额
                var zdf = (zde / value[1]) * 100; //涨跌幅
                var hsl = 0.00;
                //计算日均线
                var dayValue = [0.00, 0.00, 0.00, 0.00];
                var dayList = [5, 10, 20, 30];
                for (var z in dayList) {
                    var temValue = 0.00;
                    var times = 0;
                    for (var j = (dayList[z] - 1); j >= 0; j--) {
                        if ((i - j) >= 0) {
                            temValue += data[i - j][3];
                            times++;
                        }
                    }
                    dayValue[z] = temValue / times;
                }
                var _temp = value[0] + "^" + value[2] + "^" + value[3] + "^" + value[4] + "^" + value[5] + "^" + value[6] + "^" +
                    value[7] + "^" + zdf + "^" + zde + "^" + hsl + "^" + value[1] + "^" + dayValue[0] + "^" + dayValue[1] + "^" + dayValue[2] + "^" + dayValue[3] + "^null~";
                vlInfo += _temp;
            });
            new highStockChart('kBox', {
                cname: $("#gp-name").html(),
                vl: vlInfo
            }, []);
        });
    };

    //持仓
    var queryStrategy = function(end) {
        var Id = api.pageParam.strategyId;
        sendPost(ServicesConifg.Position.QueryDetials, {
                id: Id
            },
            function(succ) {
                document.getElementById("AStrategy").innerHTML = template("temPosition", succ);
                loadNewPrice(succ);
            },
            function(err) {
                showToast(err);
            }
        );
    };

    var saleStrategy = function(StrategyCode) {
        var $strategy = $("#" + StrategyCode);
        var StockName = $strategy.attr("StockName");
        var StockCode = $strategy.attr("StockCode");
        var dialog = api.require("dialogBox");
        dialog.alert({
            texts: {
                title: '卖出策略',
                content: '是否要卖出策略[' + StockName + '(' + StockCode + ')]',
                leftBtnTitle: '取消',
                rightBtnTitle: '马上卖出'
            },
            styles: {
                bg: '#fff',
                w: 300,
                title: {
                    marginT: 20,
                    iconSize: 40,
                    titleSize: 14,
                    titleColor: '#000'
                },
                content: {
                    color: '#000',
                    size: 14
                },
                left: {
                    marginB: 7,
                    marginL: 20,
                    w: 130,
                    h: 35,
                    corner: 2,
                    bg: '#fff',
                    size: 12
                },
                right: {
                    marginB: 7,
                    marginL: 10,
                    w: 130,
                    h: 35,
                    corner: 2,
                    bg: '#fff',
                    size: 12
                }
            }
        }, function(ret) {
            if (ret.eventType == 'left') {
                dialog.close({
                    dialogName: 'alert'
                });
            } else if (ret.eventType == 'right') {
                _submit(StrategyCode, StockCode);
                dialog.close({
                    dialogName: 'alert'
                });
            }
        });

    };

    //交易方向
    var EntrustDirection = {
        Buy: 1,
        Sell: 2
    };
    //交易模式
    var TradeType = {
        MustTrade: 0, //即时成交
        HandTrade: 1, //手动平仓
        ExpiredTrade: 2, //过期平仓
        RiskTrade: 3 //强制平仓
    };

    //策略类型
    var StrategyType = {
        FrimTrade: 0, //实盘
        SimulationTrade: 1 //模拟盘
    };

    var TradeMode = {
        T1: 0,
        TN: 1
    }
    var _submit = function(code, stockCode) {
        showLoading("提交策略中...");
        var param;
        if (api.pageParam.Type == 0) {
            param = {
                StockCode: stockCode,
                Direction: EntrustDirection.Sell,
                TradeType: TradeType.HandTrade,
                StrategyType: StrategyType.FrimTrade,
                StrategyCode: code
            };
        } else {
            param = {
                StockCode: stockCode,
                Direction: EntrustDirection.Sell,
                TradeType: TradeType.HandTrade,
                StrategyType: StrategyType.SimulationTrade,
                StrategyCode: code
            };
        }
        sendPost(ServicesConifg.Trader.SendEntrust, param,
            function(succ) {
                closeLoading();
                showToast("提交成功");
                api.sendEvent({
                    name: 'reloadStrategy'
                });
                api.sendEvent({
                    name: 'reloadSimulationStrategy'
                });
                api.closeWin();
                queryStrategy(function() {});
            },
            function(err) {
                closeLoading();
                showToast(err);
            }
        );
    };

    var changeWinGain = function(price, number, StrategyCode) {
        var content = $("#changeWinGain").html();
        content = template("changeWinGain", {
            price: price.toFixed(2),
            number: number,
            strategyCode: StrategyCode
        });
        layer.open({
            title: [
                '修改止盈价',
                'background-color: #FF4351; color:#fff;height:40px; line-height:40px;'
            ],
            btn: ['提交', '关闭'],
            content: content,
            yes: function(index) {
                var winPrice = $("#zyprice").val();
                showLoading("修改中...");
                sendPost(ServicesConifg.Position.UpdateGainLoPrice, {
                    StrategyCode: StrategyCode,
                    Price: winPrice,
                    UpdatePositionType: 1
                }, function(succ) {
                    api.pageParam.strategy.GainPrice = winPrice;
                    showToast("修改成功");
                    closeLoading();
                    queryStrategy(function() {});
                }, function(err) {
                    showToast(err);
                    closeLoading();
                });

                layer.close(index);
            }
        });
    };

    var changeLossGain = function(price, number, StrategyCode, minPrice) {
        var content = $("#changeLossGain").html();
        content = template("changeLossGain", {
            price: price.toFixed(2),
            number: number,
            minPrice: minPrice.toFixed(2),
            strategyCode: StrategyCode
        });
        layer.open({
            title: [
                '修改止损价',
                'background-color: #FF4351; color:#fff;height:40px; line-height:40px;'
            ],
            btn: ['提交', '关闭'],
            content: content,
            yes: function(index) {
                var lossPrice = $("#zsprice").val();
                var bcxyj = $("#bcxyj").val();
                if (lossPrice == 0) {
                    showLoading("止损价不能为零");
                    return false;
                }
                showLoading("修改中...");
                sendPost(ServicesConifg.Position.UpdateGainLoPrice, {
                    StrategyCode: StrategyCode,
                    Price: lossPrice,
                    Money: bcxyj,
                    UpdatePositionType: 0
                }, function(succ) {
                    api.pageParam.strategy.LossPrice = lossPrice;
                    showToast("修改成功");
                    closeLoading();
                    queryStrategy(function() {});
                }, function(err) {
                    showToast(err);
                    closeLoading();
                });

                layer.close(index);
            }
        });
    };

    var changePrice = function(code, minPrice) {
        //$("#zsprice").val(parseFloat($("#zsprice").val()).toFixed(2));
        var lossPrice = parseFloat($("#zsprice").attr("data-loss")); //原来的止损价
        var value = parseFloat($("#zsprice").val()); //新止损价
        var StockNum = $("#" + code).attr("StockNum");
        var Money = parseInt($("#" + code).attr("Money"));
        if (lossPrice > value && value < minPrice) {
            var stockPrice = parseFloat($("#" + code).attr("StockPrice")); //成本价格
            var lastMoney = parseInt(StockNum) * (stockPrice - value) / sysConfig.LossScale;
            if (lastMoney - Money > 0) {
                $("#bcxyj").val((lastMoney - Money).toFixed(0));
            } else {
                $("#bcxyj").val(0);
            }
        } else {
            $("#bcxyj").val(0);
        }
    };

    var loadNewPrice = function(_data) {
        var pParam = new Object();
        pParam.stockcode = "";
        pParam.stockcode = pParam.stockcode + _data.StockCode;
        if (pParam.stockcode == "") {
            return false;
        }
        sendPost(ServicesConifg.Quotation.StocksInfo, pParam,
            function(succ) {
                var MarkValue = 0;
                var GainValue = 0;
                for (var i in succ) {
                    $(".wcp-second-box[StockCode=" + succ[i].StockCode + "]").each(function(idx, e) {
                        var Status = $(e).attr("Status"); //策略状态
                        var $newPrice = $(e).find("span[data-for=newPrice]");
                        var $rangeMoney = $(e).find("span[data-for=rangeMoney]");

                        if (succ[i].DifferentialPersent > 0) {
                            $newPrice.removeClass("green");
                            $rangeMoney.removeClass("green");
                            $newPrice.addClass("red");
                            $rangeMoney.addClass("red");
                        } else if (succ[i].DifferentialPersent < 0) {
                            $newPrice.removeClass("red");
                            $rangeMoney.removeClass("red");
                            $newPrice.addClass("green");
                            $rangeMoney.addClass("green");
                        }
                        if (succ[i].NewPrice.toFixed(2) == 0.00) {
                            succ[i].NewPrice = succ[i].YesterdayCollect;
                        }
                        $newPrice.html(succ[i].NewPrice.toFixed(2));
                        $rangeMoney.html(succ[i].DifferentialPersent.toFixed(2) + "%");
                        if (Status == "策略执行中") {
                            var GainPrice = parseFloat($(e).attr("GainPrice")) || 0.0;
                            var LossPrice = parseFloat($(e).attr("LossPrice")) || 0.0;
                            var BuyPrice = parseFloat($(e).attr("BuyPrice")) || 0.0;
                            var StockNum = parseInt($(e).attr("StockNum")) || 0;
                            MarkValue += StockNum * succ[i].NewPrice;
                            var $gainMoney = $(e).find("span[data-for=gainMoney]"); //浮动盈亏
                            var $stopProfit = $(e).find("i[data-for=stopProfit]"); //止盈浮动
                            var $stopLoss = $(e).find("i[data-for=stopLoss]"); //止损浮动
                            $stopProfit.html(((GainPrice - succ[i].NewPrice) / succ[i].NewPrice * 100).toFixed(2) + "%");
                            $stopLoss.html(Math.abs((LossPrice - succ[i].NewPrice) / succ[i].NewPrice * 100).toFixed(2) + "%");
                            var _gain = (succ[i].NewPrice - BuyPrice) * StockNum;
                            if (_gain > 0) {
                                $gainMoney.removeClass("green");
                                $gainMoney.addClass("red");
                            } else if (_gain < 0) {
                                $gainMoney.removeClass("red");
                                $gainMoney.addClass("green");
                            }
                            $gainMoney.html(_gain.toFixed(2));
                            GainValue += _gain;

                            var $realityGainMoney = $(e).find("span[data-for=realityGainMoney]"); //实际盈亏
                            var StockPrice = parseFloat($(e).attr("StockPrice")) || 0.0;
                            var PositionFee = parseFloat($(e).attr("PositionFee")) || 0.0;
                            var _realitygain = (succ[i].NewPrice - StockPrice) * StockNum - PositionFee;
                            if (_realitygain > 0) {
                                $realityGainMoney.removeClass("green");
                                $realityGainMoney.addClass("red");
                            } else if (_realitygain < 0) {
                                $realityGainMoney.removeClass("red");
                                $realityGainMoney.addClass("green");
                            }
                            $realityGainMoney.html(_realitygain.toFixed(2));
                        }
                    });
                }
                $("#positionValues").html(MarkValue.toFixed(2));
                $("#positionProLose").html(GainValue.toFixed(2));
                $("#userMoney").html((GainValue + parseFloat($("#userMoney").html())).toFixed(2));
                if (GainValue > 0) {
                    $("#positionProLose").addClass("red");
                } else if (GainValue < 0) {
                    $("#positionProLose").addClass("green");
                }
            },
            function(err) {
                showToast("行情服务器异常");
            }, false, true
        );

        setTimeout(function() {
            loadNewPrice(_data);
        }, 10000);
    };

    function delayDay(StrategyCode, day) {
        var dialogBox = api.require("dialogBox");
        dialogBox.confirm({
            tapClose: true,
            msg: {
                content: '是否要申请延迟平仓日',
                leftBtnTitle: '取消',
                rightBtnTitle: '确定'
            },
            styles: {
                bg: '#fff',
                maskBg: 'rgba(0,0,0,0.5)',
                msg: {
                    color: '#000000',
                    size: 20,
                    maginLR: 10,
                    maginT: 15
                },
                leftBtn: {
                    color: '#000',
                    highlightBg: 'rgba(255,0,0,0.5)',
                    size: 16
                },
                rightBtn: {
                    bg: 'rgb(255,0,0)',
                    highlightBg: 'rgba(255,0,0,0.5)',
                    color: '#FFF',
                    size: 16
                }
            }
        }, function(ret) {
            if (ret.eventType == "ok") {
                showLoading("修改中...");
                sendPost(ServicesConifg.Position.UpdateIsDelay, {
                    strategyCode: StrategyCode
                }, function(succ) {
                    closeLoading();
                    showToast("已申请延期");
                    queryStrategy(function() {});
                }, function(err) {
                    closeLoading();
                    showToast(err);
                });
                dialogBox.close({
                    dialogName: 'confirm'
                });
            } else {
                closeLoading();
                dialogBox.close({
                    dialogName: 'confirm'
                });
            }
        });

    };
</script>

<body>
    <script type="text/template" charset="utf-8" id="changeLossGain">
        <!-- 止盈止损 -->
        <div class="trade-profit">
            <p><span style="color:gray; font-size:11px;">原止损价：{{price}}</span></p>
            <p>
                止损价格：
                <input type="number" oninput="changePrice('{{strategyCode}}',{{minPrice}})" data-number="{{number}}" data-loss="{{price}}" id="zsprice" class="pro-bg pro-mum red" value="{{price}}" style="border:none" step="0.01"></input>
            </p>
            <p>
                补充资金：
                <input type="number" id="bcxyj" class="pro-bg pro-mum red" value="0" style="border:none"></input>
            </p>
        </div>
    </script>
    <script type="text/template" charset="utf-8" id="changeWinGain">
        <!-- 止盈止损 -->
        <div class="trade-profit">
            <p><span style="color:gray; font-size:11px;">原止盈价：{{price}}</span></p>
            <p>
                止盈价格：
                <input type="number" id="zyprice" class="pro-bg pro-mum red" value="{{price}}" style="border:none" step="0.01"></input>
            </p>
        </div>
    </script>
    <script type="text/template" charset="utf-8" id="temPosition">
        <li id="{{StrategyCode}}" class="wcp-second-box" Money="{{Money}}" PositionFee="{{PositionFee}}" StockCode="{{StockCode}}" BuyPrice="{{BuyPrice}}" StockName="{{StockName}}" StockNum="{{StockNum}}" GainPrice="{{GainPrice}}" LossPrice="{{LossPrice}}" Status="{{Status}}"
            StockPrice="{{StockPrice}}">
            <div class="stra-cc">
                {{if Status=="策略执行中"}}
                <ul>
                    <li class="stra-cc-tit">
                        <span style="color:#f7900f; padding: 0rem .3rem;margin-right: .3rem;">{{if TradeModel==0}}T1{{else}}TN{{/if}}</span>
                        <span>{{StockName}}</span>
                        <i>{{StockCode}}</i>
                    </li>
                    <li>
                        <span class="" data-for="newPrice">0</span>
                        <span class="stra-cc-jg" data-for="rangeMoney">0.0</span>
                    </li>
                    <li>买入价：<span class="color1">{{fixd(BuyPrice)}}</span></li>
                    <li>成本价：<span class="color1">{{fixd(StockPrice)}}</span></li>
                    <li>浮盈：<span class="" data-for="gainMoney">0</span></li>
                    <li>盈亏：<span class="" data-for="realityGainMoney">0</span></li>
                    {{if TradeModel==0}} {{if IsDelay}}
                    <li class="stra-cc-cz">已持仓{{Day}}天,下交易日平仓</li>
                    {{else}} {{if Day > 0}}
                    <li class="stra-cc-cz">今日14:50平仓</li>
                    {{else}}
                    <li class="stra-cc-cz">下交易日14:50平仓</li>
                    {{/if}} {{/if}} {{else}}
                    <li class="stra-cc-cz">已持仓{{Day}}天</li>
                    {{/if}}
                    <li class="stra-cc-cz">买入时间：<span class="">{{DateFormat(BuyTime)}}</span></li>
                </ul> {{else}}
                <div class="stra-wait">
                    <ul>
                        <li class="stra-cc-tit">
                            <span style="font-size:16px;">{{StockName}}</span>
                            <i>{{StockCode}}</i>
                        </li>
                        <li style="font-size:16px;">
                            <span class="" data-for="newPrice">0</span><br/>
                            <span class=" stra-cc-jg" data-for="rangeMoney">0.0</span>
                        </li>
                    </ul>
                    <div class="stra-status">
                        策略挂单中··· ···
                    </div>
                </div>
                {{/if}}
            </div>
            <div class="stra-cc-box" style="display:block;">
                <ul>
                    <li class="w1">信用金<span class="orange">{{Money}}</span></li>
                    <li class="w1">止盈价<span class="red">{{GainPrice}}</span></li>
                    <li class="w2">上涨<i class="red" data-for="stopProfit">0</i>触发止盈</li>
                    <li class="w1">股票数<span class="orange">{{StockNum}}</span></li>
                    <li class="w1">止损价<span class="green">{{LossPrice}}</span></li>
                    <li class="w2">下跌<i class="green" data-for="stopLoss">0</i>触发止损</li>
                    <li style="width:30%;">交易手续费<span class="orange">{{fixd(BuyFee)}}</span></li>
                    <li style="width:30%;">管理费<span class="orange">{{fixd(PositionFee)}}</span></li>
                    <li style="width:40%;">强平价<span class="orange">{{fixd(ForceMoney)}}</span></li>
                </ul>
                <p>
                    <a href="#" onclick="changeWinGain({{GainPrice}},{{StockNum}},'{{StrategyCode}}')"><button class="wcp-btn wcp-btn-pad01 wcp-btn-orange">修改止盈</button></a>
                    <a href="#" onclick="changeLossGain({{LossPrice}},{{StockNum}},'{{StrategyCode}}',{{ForceMoney}})"><button class="wcp-btn wcp-btn-pad01 wcp-btn-orange">修改止损</button></a> {{if TradeModel==0}} {{if IsDelay == false}}
                    <a href="#"><button class="wcp-btn wcp-btn-pad01 wcp-btn-green" onclick="delayDay('{{StrategyCode}}',{{Day}})">延迟平仓日</button></a> {{/if}} {{/if}} {{if Day > 0}}
                    <a href="#" onclick="saleStrategy('{{StrategyCode}}')"><button class="wcp-btn wcp-btn-pad01 wcp-btn-red">卖出</button></a> {{/if}}
                </p>
            </div>
        </li>
    </script>

    <script type="text/template" charset="utf-8" id="templateStock">
        <div class="gp-tit">
            <div class="gp-name"> {{StockName }}
                <span class="gp-num"> {{StockCode }}
                    </span>
            </div>
            <div class="gp-jg {{Color}}"> {{fixd(CurrentMatch)}}
                <span class="{{Color}}"> {{fixd(Differential)}}&nbsp; &nbsp; &nbsp; {{fixd(DifferentialPersent)}}%
                                </span>
            </div>
            <!-- <div class="gp-onoff"><i class="iconfont icon-arrow-copy"></i></div> -->
        </div>
        <div class="gp-market">
            <ul class="market-xq">
                <li class="w1"> 今开
                    <span style="color:{{if TodayOpen > PreClose}}red{{else if PreClose > TodayOpen}}green{{else}}black{{/if}}"> {{fixd(TodayOpen)}}</span>
                </li>
                <li class="w1"> 最高
                    <span style="color:{{if HighestPrice > PreClose}}red{{else if PreClose > HighestPrice}}green{{else}}black{{/if}}"> {{fixd(HighestPrice)}}</span>
                </li>
                <li class="w2"> 成交量
                    <span style="color:black"> {{DealVolume }}手</span>
                </li>
                <li class="w3" style="color:red"> 涨停价
                    <span class="red"> {{fixd(UpLimit)}}</span>
                </li>
                <li class="w1"> 昨收
                    <span style="color:black"> {{fixd(PreClose)}}</span>
                </li>
                <li class="w1"> 最低
                    <span style="color:{{if MinimumPrice > PreClose}}red{{else if PreClose > MinimumPrice}}green{{else}}black{{/if}}"> {{fixd(MinimumPrice)}}</span>
                </li>
                <li class="w2"> 成交额
                    <span style="color:black"> {{DealMoney }}万</span>
                </li>
                <li class="w3" style="color:green"> 跌停价
                    <span class="green"> {{fixd(DownLimit)}}</span>
                </li>
            </ul>
        </div>
    </script>
    <script type="text/template" charset="utf-8" id="templateStalls">
        {{each List as value}}
        <tr class="{{value.cls}}">
            <td width="55px" align="center">{{value.Index}}</td>
            <td width="80px">{{value.Price}}</td>
            <td align="right" style="color:#0099FF">{{value.Volume}}</td>
        </tr>
        {{/each}}
    </script>
    <!-- header -->
    <div class="header">
        <a href="#" class="back">

            <i class="arrow_left"></i>
        </a>
        <div class="search_box nei_tit">
            查看行情
        </div>
        <!--  <a class="right-ico tel" href="tel:400-000-0000"></a> -->
    </div>
    <div class="ui-container">
        <!-- 股票行情 -->
        <div id="stockInfo" class="stock_info_box">
            <div class="gp-tit">
                <div class="gp-name">-<span class="gp-num">-</span></div>
                <div class="gp-jg red">0.00<span class="red">0.00 &nbsp;&nbsp;&nbsp; 0.00%</span></div>
                <!-- <div class="gp-onoff"><i class="iconfont icon-arrow-copy"></i></div> -->
            </div>
            <div class="gp-market">
                <ul class="market-xq">
                    <li class="w1">今开<span style="color:black">0.00</span></li>
                    <li class="w1">最高<span style="color:black">0.00</span></li>
                    <li class="w2">成交量<span style="color:black">0手</span></li>
                    <li class="w3" style="color:red">涨停价<span class="red">0.00</span></li>
                    <li class="w1">昨收<span style="color:black">0.00</span></li>
                    <li class="w1">最低<span style="color:black">0.00</span></li>
                    <li class="w2">成交额<span style="color:black">0万</span></li>
                    <li class="w3" style="color:green">跌停价<span class="green">0.00</span></li>
                </ul>
            </div>
        </div>
        <div class="tabs" id="wrapper-tabs">
            <ul>
                <li class="active"><a href="#">实时行情</a></li>
                <li><a href="#">k线行情</a> </li>
            </ul>
        </div>
        <!-- 行情表 -->
        <div class="swiper-container">
            <div class="swiper-wrapper">
                <div class="quotation_box swiper-slide">
                    <div class="line" style="width: 100%;height:17rem;">
                        <div id="hqInfo" style="width: 100%;height:17rem;">

                        </div>
                    </div>
                    <div class="stalls ">
                        <table id="stalls">

                        </table>
                    </div>
                </div>
                <div class="k_box swiper-slide">
                    <div id="kBox" style="width: 100%;height:17rem;" class="swiper-no-swiping"></div>
                </div>
            </div>
        </div>
        <ol id="AStrategy" style="paddding-top:0.65rem;">

        </ol>
        <div id="addlink" class="fill-btn">
            <span class="wcp-btn wcp-btn-pad03 wcp-btn-opcity">创建策略</span>
        </div>
    </div>

</body>

</html>
